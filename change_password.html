<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Secure Web App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="with-navbar">


    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-content">
            <h1>Secure Web App</h1>
            <div class="nav-links">
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                <a href="{{ url_for('profile') }}">Profile</a>
                {% if session.get('role') == 'admin' %}
                    <a href="{{ url_for('admin_panel') }}">Admin Panel</a>
                {% endif %}
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </div>

    <!-- Change Password Form -->
    <div class="auth-container">
        <div class="form-container">

            <h2>Change Password</h2>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('change_password') }}" onsubmit="return checkPasswordMatch()">

                <!-- Current Password -->
                <label for="current_password">
                    Current Password
                    <span class="eye-toggle" onclick="toggleCurrent()">üëÅ</span>
                </label>
                <input type="password" id="current_password" name="current_password"
                       placeholder="Enter your current password" required>

                <!-- New Password -->
                <label for="new_password">
                    New Password
                    <span class="eye-toggle" onclick="toggleNew()">üëÅ</span>
                </label>
                <input type="password" id="new_password" name="new_password"
                       placeholder="Enter a new password" required>
                <div id="strength" class="password-help"></div>
                <div id="hints" class="password-help"></div>

                <!-- Confirm Password -->
                <label for="confirm_password">
                    Confirm New Password
                    <span class="eye-toggle" onclick="toggleConfirm()">üëÅ</span>
                </label>
                <input type="password" id="confirm_password" name="confirm_password"
                       placeholder="Re-enter your new password" required>
                <div id="matchError" class="error"></div>

                <button type="submit" class="btn btn-primary">
                    Change Password
                </button>

                <a href="{{ url_for('profile') }}" class="btn btn-secondary" style="margin-top:10px; display:block;">
                    Back to Profile
                </a>

            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const currentPassword = document.getElementById("current_password");
        const newPassword = document.getElementById("new_password");
        const confirmPassword = document.getElementById("confirm_password");

        const strength = document.getElementById("strength");
        const hints = document.getElementById("hints");
        const matchError = document.getElementById("matchError");

        function toggleCurrent() {
            currentPassword.type = currentPassword.type === "password" ? "text" : "password";
        }

        function toggleNew() {
            newPassword.type = newPassword.type === "password" ? "text" : "password";
        }

        function toggleConfirm() {
            confirmPassword.type = confirmPassword.type === "password" ? "text" : "password";
        }

        newPassword.addEventListener("input", () => {
            let score = 0;
            let hintText = [];

            if (newPassword.value.length >= 8) score++; else hintText.push("‚Ä¢ At least 8 characters");
            if (/[A-Z]/.test(newPassword.value)) score++; else hintText.push("‚Ä¢ Must contain an uppercase letter");
            if (/[a-z]/.test(newPassword.value)) score++; else hintText.push("‚Ä¢ Must contain a lowercase letter");
            if (/[0-9]/.test(newPassword.value)) score++; else hintText.push("‚Ä¢ Must contain a number");
            if (/[^A-Za-z0-9]/.test(newPassword.value)) score++; else hintText.push("‚Ä¢ Must contain a special character");

            if (newPassword.value.length === 0) {
                strength.textContent = "";
                hints.textContent = "";
                return;
            }

            if (score <= 1) {
                strength.textContent = "Weak password";
                strength.className = "password-help weak";
            } else if (score <= 3) {
                strength.textContent = "Good password";
                strength.className = "password-help good";
            } else {
                strength.textContent = "Strong password";
                strength.className = "password-help strong";
            }

            hints.innerHTML = hintText.join("<br>");
        });

        function checkPasswordMatch() {
            if (newPassword.value !== confirmPassword.value) {
                matchError.textContent = "Passwords do not match.";
                return false;
            }
            matchError.textContent = "";
            return true;
        }
    </script>

</body>
</html>
